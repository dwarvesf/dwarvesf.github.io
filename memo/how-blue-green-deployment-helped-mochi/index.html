<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=keywords content><meta name=title content="How Blue Green Deployment Helped Mochi"><meta name=description content><meta property="og:title" content="How Blue Green Deployment Helped Mochi"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://note.d.foundation/memo/how-blue-green-deployment-helped-mochi/"><meta property="og:image" content="https://note.d.foundation/img/LOGO.png"><meta property="twitter:title" content="How Blue Green Deployment Helped Mochi"><meta property="twitter:description" content><meta property="twitter:type" content="article"><meta property="twitter:url" content="https://note.d.foundation/memo/how-blue-green-deployment-helped-mochi/"><meta property="twitter:image" content="https://note.d.foundation/img/LOGO.png"><link rel=icon type=image/x-icon href=https://note.d.foundation/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://note.d.foundation/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://note.d.foundation/favicon-32x32.png><link rel=apple-touch-icon href=https://note.d.foundation/apple-touch-icon.png><title>How Blue Green Deployment Helped Mochi</title>
<link rel=canonical href=https://note.d.foundation/memo/how-blue-green-deployment-helped-mochi/><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vs.min.css integrity="sha512-Jn4HzkCnzA7Bc+lbSQHAMeen0EhSTy71o9yJbXZtQx9VvozKVBV/2zfR3VyuDFIxGvHgbOMMNvb80l+jxFBC1Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: dark)"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: light)"><script defer data-domain=note.d.foundation src=https://plausible.io/js/script.js></script><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script><link rel=preconnect href=https://B0BWKXLVM9-dsn.algolia.net crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script><style>body{font-family:ibm plex sans,sans-serif;font-size:1rem;color:#000;text-rendering:optimizeLegibility;padding:2rem;max-width:100%;margin:0;padding:0;background-color:var(--primary-background-color-light);line-height:1.5;min-height:100vh;display:flex;flex-direction:column;hyphens:auto}h1,h2,h3,h4{color:var(--primary-font-color);line-height:1.24}h1{font-size:32pt}h2{font-size:24pt}h3{font-size:16pt}h4{font-size:12pt}a[href^="#"]{text-decoration:none}time{padding-right:1rem}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #eee}img{max-width:100%}video{max-width:100%}a,a:visited{color:#000}q{font-size:20px;max-width:500px;display:block;margin-left:30px}pre{font-family:monospace!important;background:#000!important;color:#dadada;padding:4px!important;margin:0!important;border-radius:2px;overflow-x:auto;width:100%;max-width:100vw!important;box-sizing:border-box;background-clip:padding-box}pre>code{text-indent:0;white-space:inherit;font-weight:400;padding:15px!important;box-sizing:border-box;background-clip:padding-box}code{line-height:1.5!important;font-family:monospace!important;font-size:12px!important;background:#333!important;color:#dadada;padding:2px 5px;white-space:wrap;border-radius:2px;font-weight:700;display:inline-block;margin-bottom:-4px;box-sizing:border-box;background-clip:padding-box}code comment{color:#777}table code{margin:0;background:var(--secondary-background-color-light)!important;color:var(--secondary-font-color-light);border:.5px solid var(--secondary-font-color-light)}span a,span a:visited{color:inherit}[style*="color:yellow"]{color:gold!important}[style*="color:blue"]{color:#6495ed!important}[style*="color:red"]{color:crimson!important}@media(prefers-color-scheme:dark){a,a:visited{color:#dadada}pre{font-family:monospace!important;background:#fff!important;color:var(--primary-background-color)}code{font-family:monospace!important;background:#ddd!important;color:var(--primary-background-color)}table code{background:var(--secondary-background-color)!important;color:var(--secondary-font-color)}}iframe{box-sizing:border-box;max-width:100%}@media(prefers-color-scheme:light){h1,h2,h3,h4{color:var(--primary-font-color-light)}}@media screen and (max-width:1100px){h1{font-size:calc(1.45rem + 2vw)}h2{font-size:calc(1rem + 1.5vw)}h3{font-size:calc(1rem + 1vw)}h4{font-size:calc(1rem + .5vw)}}:root{--primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--primary-font-color:#ddd;--primary-font-color-light:#333;--secondary-font-color:#e8e8e8;--secondary-font-color-light:#717171;--primary-background-color:#1e1e1e;--primary-background-color-light:#fff;--secondary-background-color:#282828;--secondary-background-color-light:#f6f6f6;--border-color:#3d3d3d;--border-color-light:#e7e7e7;--container-max-width:1240px;--main-padding:36px;--column-gap:24px;--nav-sidebar-width:200px;--nav-sidebar-offset:0px}.grid .title{grid-area:title;margin:32px 0 0!important;color:var(--primary-color)}.grid .subtitle{grid-area:subtitle;font-size:18px;padding-top:16px;padding-bottom:32px}.grid #docsearch{grid-area:docsearch}.grid #docsearch>button{width:90%;height:75%;border-radius:0}.grid #docsearch>button>span{padding-left:12px;font-family:ibm plex sans,sans-serif}.DocSearch-Footer{box-shadow:none}.active{color:var(--primary-color);line-height:1;border-bottom:2px solid var(--primary-color);padding-top:4px!important}nav.tab-menu{grid-area:tabmenu;border-bottom:1px solid var(--border-color-light);padding-bottom:0;overflow:auto}nav.tab-menu ul{list-style-type:none;padding:0;margin-bottom:0;display:inline-grid;grid-auto-flow:column;grid-template-rows:1fr;grid-template-columns:repeat(auto-fit,minmax(min-content,1fr));column-gap:48px}nav.tab-menu ul li{font-size:16px;font-weight:500;display:inline-block;padding:0 0 16px;width:min-content}nav.tab-menu ul li a{text-decoration:none;color:inherit}nav.tab-menu ul li a:hover{background-color:var(--primary-background-color);padding:0}nav.tab-menu ul li:last-of-type{margin-right:30px!important}@media(prefers-color-scheme:dark){nav.tab-menu{border-bottom:1px solid var(--border-color)}}@media only screen and (max-width:1100px){.DocSearch{width:100%!important;height:50px!important;padding:0;margin:0}}nav.menu{padding:calc(var(--main-padding) - 12px)var(--main-padding);line-height:22px;white-space:nowrap;grid-area:nav}details{margin-left:-7px;overflow:hidden;font-size:14px}summary{display:block;padding:5px 5px 12px 20px;position:relative;cursor:pointer;font-size:20px;font-weight:600;text-transform:capitalize;user-select:none}nav section details:not(:last-of-type) ul{margin-bottom:24px}summary:before{content:'\25B8';position:absolute;top:7px;left:0;transform:rotate(0);transform-origin:50% 50%;transition:.25s transform ease;font-size:16px;height:16px;width:16px;font-weight:200;display:flex;justify-content:center;align-items:center}summary:before>*{height:4px;width:4px}details[open]>summary:before{transform:rotate(90deg)}details summary::-webkit-details-marker{display:none}details>ul{margin-bottom:0}hr{margin:20px 0!important;width:100%;max-width:inherit;border-color:var(--secondary-background-color-light)}nav.menu{background-color:var(--secondary-background-color-light)}nav .site-nav{display:inline-block;width:100%}nav .site-nav section{margin-top:-2px}nav .site-nav section h2{margin:20px 0;font-size:24px;text-transform:lowercase}nav.menu ul{display:inline-grid;grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(auto-fill,minmax(var(--nav-sidebar-width),1fr));padding:0 10px 10px 0;margin:0;list-style-type:none;line-height:22px;box-sizing:border-box}nav .site-nav ul li{list-style-type:none;display:flex;font-variant-numeric:tabular-nums;font-size:14px;padding-left:20px;max-width:fit-content}nav .site-nav ul li a{padding:0 4px}.load-more{font-style:italic;padding-top:8px;color:var(--primary-color)!important;cursor:pointer}@media(prefers-color-scheme:dark){nav.menu{background-color:var(--secondary-background-color)}hr{border-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){nav.menu{padding:4.5%}nav.menu ul{width:100%;row-gap:4px;column-gap:4px}nav .site-nav section{margin:0 10px 10px 0}nav.menu{max-width:100%;box-sizing:border-box;display:inline-block}}footer{padding:var(--main-padding);clear:both;border-top:1px solid var(--border-color-light)}footer span{color:var(--secondary-font-color-light)}@media(prefers-color-scheme:dark){footer{border-top:1px solid var(--border-color)}footer span{color:var(--secondary-font-color)}}.note-title{display:inline-grid;width:100%;row-gap:12px;margin:0;grid-template-areas:"pagetitle pagetitle" "date tags" "authors tags";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(2,1fr)}.note-title .pagetitle{grid-area:pagetitle;margin:0}.note-title .date{grid-area:date;color:#636466}.note-title .tags{display:inline-flex;flex-wrap:wrap;gap:6px;grid-area:tags;justify-self:right;justify-content:right}.note-title .tags .tag{padding:1px 6px;border-radius:4px;background-color:var(--secondary-background-color-light);height:fit-content;text-decoration:none;color:var(--secondary-font-color-light)}.note-title .authors{grid-area:authors}.clear-title{grid-template-areas:"pagetitle pagetitle";gap:0}.clear-title .date{display:none}.clear-title .tags{display:none}.clear-title .authors{display:none}code.button{background:var(--primary-background-color-light);color:#000;font-size:smaller;display:inline-block;padding:0 6px;font-weight:700;border-radius:2px;line-height:22px}.grid{display:inline-grid;grid-template-areas:"title title title title" "subtitle subtitle docsearch docsearch" "tabmenu tabmenu tabmenu tabmenu" "nav content content pagenav" "nav content content pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:325px 2fr 2fr 1fr;column-gap:var(--column-gap)}.grid>*{padding-right:calc(var(--main-padding) - 12px);padding-left:calc(var(--main-padding) + 12px)}#docsearch{grid-area:docsearch}main{grid-area:content;display:inline-block;padding:var(--main-padding);width:calc(100vw - 325px - 72px);max-width:var(--container-max-width);box-sizing:border-box;overflow-wrap:break-word;hyphens:none;justify-self:left}main ul{line-height:25px;margin:0;padding:0;padding-inline-start:40px}main ul>li>a{text-decoration:underline}.scrollable{overflow:auto}.dual-list>ul{columns:2}.single-list>ul{columns:2}.profile img{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}.profile object{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}table,th,td{border:1px solid;border-collapse:collapse;border-spacing:0;border-color:var(--border-color-light)}thead *{padding:6px 12px;background-color:var(--secondary-background-color-light)}th,td{padding:6px 12px;overflow:hidden;text-overflow:ellipsis;vertical-align:top;text-align:left}td:has(img){padding:12px;line-height:0}table{table-layout:fixed}table:has(th:empty){border:none}table:has(th:empty) th{border:none;padding:0;line-height:0}table:has(th:empty) td{border:none}table:has(img){width:100%;height:100%}table:has(img) td{min-width:200px}table:has(img) img{width:100%!important;height:100%!important;object-fit:cover}#TableOfContents>ul>li>a{text-decoration:underline}#TableOfContents>ul{display:grid;column-gap:var(--column-gap);box-sizing:border-box;grid-template-columns:repeat(auto-fill,minmax(0,calc(50% - var(--column-gap))));line-height:20px}#TableOfContents li{white-space:nowrap;list-style-type:decimal-leading-zero;list-style-position:inside;overflow:hidden;text-overflow:ellipsis}.notice{padding:20px;border:2px solid #000;margin-bottom:16px}main>blockquote{padding:20px;border:2px solid #000}main>*{max-width:inherit}li:has(input[type=checkbox]){display:block;list-style-type:none}ul:has(li input[type=checkbox]){padding:0}ul li a{overflow:hidden;text-overflow:ellipsis;white-space:wrap;text-decoration:none;transition:all .25s ease}ul li a:hover{background-color:var(--primary-color);color:#fff;padding-left:4px;padding-right:4px;border-radius:4px;width:100%;z-index:10}ul li p{margin-block-end:0;margin-block-start:0}@media(prefers-color-scheme:dark){html[data-theme=dark]{--docsearch-searchbox-background:var(--secondary-background-color);--docsearch-modal-background:var(--secondary-background-color);--docsearch-footer-background:var(--secondary-background-color);--docsearch-key-gradient:linear-gradient(-26.5deg, #555, var(--secondary-background-color));--docsearch-muted-color:#777;--docsearch-key-shadow:inset 0 -2px 0 0 var(--secondary-background-color),inset 0 0 1px 1px #555,0 2px 2px 0 rgba(3,4,9,0.3)}body{background:var(--primary-background-color);color:#dadada}body select{color:#000;background-color:#fff}.project{border-left:2px solid #fff}.notice{border-color:#fff}.mono{filter:invert(1)}.progress>div{background-color:#fff}.progress>div>span{color:#000}main>blockquote{border-color:#fff}ul li a{background-color:inherit}section>ul li a{background-color:inherit}.note-title .tags .tag{background-color:var(--secondary-background-color);color:var(--secondary-font-color)}table,th,td{border-color:var(--border-color)}thead *{background-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){.grid{display:inline-grid;grid-template-areas:"title" "subtitle" "docsearch" "tabmenu" "content" "nav" "pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.grid>*{padding-right:4.5%;padding-left:4.5%}.note-title{width:100%;grid-template-areas:"pagetitle" "date" "tags" "authors";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.note-title .tags{max-width:max-content;justify-self:left;justify-content:flex-start}main{justify-self:center;width:100%;max-width:700px}}.col-2{display:inline-grid;column-gap:36px;padding-bottom:36px;grid-template-columns:repeat(auto-fit,minmax(20%,1fr))}.col-2>*{overflow-wrap:break-word;overflow:auto}</style><script defer src=/js/process-comments.js></script><script defer src=/js/tab-menu.js></script><script defer src=/js/markdown-entities.js></script><script defer src=/js/algolia.js></script><script defer src=/js/dark-light-check.js></script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"memo","name":"How Blue Green Deployment Helped Mochi","headline":"How Blue Green Deployment Helped Mochi","alternativeHeadline":"","description":"At Dwarves Foundation, our team has always faced some bit of friction when deploying apps for our clients. We’ve known about blue-green deployments for a while and were recently given the chance to evaluate and demonstrate them for one of our Discord bot projects.\nApplying Blue-green deployment for Mochi Bot Introducing Mochi Bot to the Web3 space, our team has developed a flexible and user-friendly product with features like NFT rarity queries, sales alerts on Discord and Twitter, and showing various tips.","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/note.d.foundation\/memo\/how-blue-green-deployment-helped-mochi\/"},"author":{"@type":"Person","name":"Han Ngo"},"creator":{"@type":"Person","name":"Han Ngo"},"accountablePerson":{"@type":"Person","name":"Han Ngo"},"copyrightHolder":"Dwarves Foundation","copyrightYear":"2023","date":"2023-04-03T00:00:00.00Z","dateCreated":"2023-04-03T00:00:00.00Z","datePublished":"2023-04-03T00:00:00.00Z","dateModified":"2023-04-03T00:00:00.00Z","publisher":{"@type":"Organization","name":"Dwarves Foundation","url":"https://note.d.foundation/","logo":{"@type":"ImageObject","url":"https:\/\/note.d.foundation\/","width":"32","height":"32"}},"image":"https://note.d.foundation/","url":"https:\/\/note.d.foundation\/memo\/how-blue-green-deployment-helped-mochi\/","wordCount":"894","genre":["devops","performance","engineering"],"keywords":["devops","performance","engineering"]}</script><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script type=text/javascript>window.addEventListener("DOMContentLoaded",function(){document.body.style.visibility="visible",document.body.style.opacity=1})</script></head><body><div class=grid><h1 class=title><a style=color:inherit;text-decoration:none href=/site-index>Dwarves Notes</a></h1><div class=subtitle>A collection of notes for everything we do and operate at Dwarves.</div><div id=docsearch></div><nav class=tab-menu x-data="{
    currentUrl: `/memo/how-blue-green-deployment-helped-mochi/`,
    links: [
      { title: 'Home', url: '/home/' },
      { title: 'Consulting', url: '/memo/consulting/' },
      { title: 'Labs', url: '/memo/labs' },
      { title: 'Earn', url: '/earn/' },
      { title: 'Hiring', url: '/hiring/' },
      { title: 'Newsletter', url: '/newsletter/' },
      { title: 'Events', url: '/events/' },
    ],
    activeUrl: '',
    isActiveUrl(url) {
      if (!this.activeUrl) {
        this.activeUrl = this.currentUrl.startsWith(url);
        return this.activeUrl;
      }
    },
  }"><ul><template x-for="item in links"><li x-bind:class="{ 'active': isActiveUrl(item.url) }"><a x-bind:href=item.url x-text=item.title></a></li></template></ul></nav><nav class=menu><section class=site-nav x-data="{
      currentUrl: `/memo/how-blue-green-deployment-helped-mochi/`,
      get data() {
        const dataString = `[]`;
        const data = JSON.parse(dataString);
        data.sort((a, b) => Date.parse(b.date) - Date.parse(a.date));
        console.log(data);
        return data;
      },
    }"><template x-for="item in data" x-bind:key=item><details x-data="{ start: 0, end: 10, loaded: false, loadText: 'Load more...', }" open><summary>Pinned Notes</summary><ul><li><a x-bind:href=item.url x-text=item.title></a></li></ul></details></template></section></nav><main x-data='{
      currentUrl: `/memo/how-blue-green-deployment-helped-mochi/`,
      title: `How Blue Green Deployment Helped Mochi`,
      get tagsData() {
        const dataString = `[{"tags":["devops","performance","engineering"],"url":"/memo/how-blue-green-deployment-helped-mochi/"}]`;
        const data = JSON.parse(dataString);
        return data;
      },
      isClearPage() {
        const showFrontmatter = (/true/i).test(`true`);
        return !showFrontmatter || this.currentUrl.includes(&#39;home&#39;) || this.currentUrl.includes(&#39;tags&#39;);
      },
      isTagPage() {
        return this.currentUrl.includes(&#39;tags&#39;);
      }
    }'><template x-if=!!title><div x-bind:class="{ 'note-title': true, 'clear-title': isClearPage() }"><div class=title-index style=display:none>How Blue Green Deployment Helped Mochi</div><div class=tags-index style=display:none>tags: devops, performance, engineering</div><template x-if=isTagPage()><h1 class=pagetitle x-text="`#${title}`"></h1></template><template x-if=!isTagPage()><h1 class=pagetitle x-text=title>How Blue Green Deployment Helped Mochi</h1></template><div class=date>Apr 3, 2023</div><template x-for="data in tagsData"><template x-if="data.tags && data.tags.length > 0"><div class=tags>Tags:
<template x-for="tag in data.tags"><a class=tag x-bind:href="`/tags/${tag.toLowerCase()}`" x-text=tag></a></template></div></template></template></div><hr></template><p><em>At Dwarves Foundation, our team has always faced some bit of friction when deploying apps for our clients. We’ve known about blue-green deployments for a while and were recently given the chance to evaluate and demonstrate them for one of our Discord bot projects.</em></p><h1 id=applying-blue-green-deployment-for-mochi-bot><a href=#applying-blue-green-deployment-for-mochi-bot>Applying Blue-green deployment for Mochi Bot <a href=#applying-blue-green-deployment-for-mochi-bot></a></a></h1><p>Introducing <a href=https://mochi.gg/>Mochi Bot</a> to the Web3 space, our team has developed a flexible and user-friendly product with features like NFT rarity queries, sales alerts on Discord and Twitter, and showing various tips. To enhance user experience and streamline deployment, we had the chance to implement <a href=https://radar.d.foundation/Blue-green-deployment-a93ea5c3d4d8439ba8701aec57d7ea3c>blue-green deployment</a> for the Mochi Bot application. Below is our case study that evaluates the cost and practicality of this deployment strategy in our current infrastructure.</p><h2 id=current-infrastructure--implementation-plan><a href=#current-infrastructure--implementation-plan><strong>Current Infrastructure & Implementation Plan</strong> <a href=#current-infrastructure--implementation-plan></a></a></h2><p>Mochi Bot runs on a Kubernetes infrastructure managed by ArgoCD, with two pods. By implementing blue-green deployment, we aim to eliminate downtime and ensure consistent updates across pods. To achieve this, we set up two identical production environments (blue and green) and followed these steps:</p><ol><li>Evaluate current infrastructure and identify prerequisites.</li><li>Prepare Kubernetes manifests for blue and green environments.</li><li>Apply new configurations to clusters.</li><li>Test deployment process, including traffic switching and rollback procedures.</li></ol><h2 id=preparation--resource-definition><a href=#preparation--resource-definition><strong>Preparation & Resource Definition</strong> <a href=#preparation--resource-definition></a></a></h2><p>To implement blue-green deployment in Kubernetes, we needed to define the application resources and the rollout strategy. We defined the application resources using three YAML files:</p><pre><code class=language-plain_text>.
└── app/
    ├── bluegreen-rollout.yaml
    ├── ingress.yaml
    └── service.yaml
</code></pre><p>Before that, setting up <a href=https://github.com/argoproj/argo-rollouts>Argo Rollouts</a> is a prerequisite to enable blue-green deployment capability:</p><pre><code class=language-bash>kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
</code></pre><p>The blue-green update strategy is applied to define the release through the <code>bluegreen-rollout.yaml</code> file.</p><pre><code class=language-bash># bluegreen-rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: mochiapp
  labels:
    app: mochiapp
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: mochiapp
  template:
    metadata:
      labels:
        app: mochiapp
    spec:
      containers:
        - name: myapp
          image: argoproj/rollouts:blue
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
  strategy:
    blueGreen:
      autoPromotionEnabled: false
      activeService: mochiapp
      previewService: mochiapp-preview
</code></pre><p>The <code>bluegreen-rollout.yaml</code> file is structured similarly to a typical deployment file, but with the added <code>strategy</code> section. Here, we specified the <code>activeService</code> to update with the new template hash during promotion (required), and the <code>previewService</code> to update with the new template hash before (optional).</p><p>Next, we created the <code>ingress.yaml</code> and <code>service.yaml</code> files, which contained the respective configurations for ingress and service resources:</p><pre><code class=language-bash># ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mochiapp
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - mochiapp.bluegreen.domain
      secretName: mochiapp.bluegreen.domain-tls
  rules:
    - host: mochiapp.bluegreen.xyz
      http:
        paths:
          - pathType: Prefix
            path: &quot;/&quot;
            backend:
              service:
                name: mochiapp
                port:
                  name: http

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mochiapp-preview
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - preview.mochiapp.xyz
      secretName: preview-mochiapp.bluegreen.domain-tls
  rules:
    - host: preview-mochiapp.bluegreen.domain
      http:
        paths:
          - pathType: Prefix
            path: &quot;/&quot;
            backend:
              service:
                name: mochiapp-preview
                port:
                  name: http
</code></pre><pre><code class=language-bash># service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mochiapp
  labels:
    app: mochiapp
spec:
  selector:
    app: mochiapp
  ports:
    - name: http
      port: 80
      targetPort: http
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: mochiapp-preview
  labels:
    app: mochiapp
spec:
  selector:
    app: mochiapp
  ports:
    - name: http
      port: 80
      targetPort: http
  type: ClusterIP
</code></pre><h2 id=applying-resources-to-the-cluster-and-testing><a href=#applying-resources-to-the-cluster-and-testing>Applying Resources to the Cluster and Testing <a href=#applying-resources-to-the-cluster-and-testing></a></a></h2><p>We applied the resource files to the Kubernetes cluster using <code>**kubectl apply**</code> commands. The application was deployed to the active environment and could be viewed on the production domain - <code>mochiapp.bluegreen.domain</code>.</p><pre><code class=language-bash>kubectl apply -f app/bluegreen-rollout.yaml
kubectl apply -f app/service.yaml
kubectl apply -f app/ingress.yaml
</code></pre><p><img x-data="{
    altText: `f711c252bf191800d3184c8839221899_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/how-blue-green-deployment-helped-mochi/f711c252bf191800d3184c8839221899_MD5.webp alt=f711c252bf191800d3184c8839221899_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p><p>When releasing a new version, we changed the image of the application and applied the changes to the cluster. Argo rollouts created a new ReplicaSet with the new image and initiated the rollout of the updated version in the preview environment, accessible at the preview domain - <code>preview-mochiapp.bluegreen.domain</code>.</p><pre><code class=language-bash># bluegreen-rollout.yaml
containers:
	- name: myapp
	  image: argoproj/rollouts-demo:green
</code></pre><pre><code class=language-bash>kubectl apply -f app/bluegreen-rollout.yaml
</code></pre><p>Once the updated application version was thoroughly tested, we promoted it to the active environment using a specific command. The updated application was then accessible on the active environment in the blue domain.</p><pre><code class=language-bash>kubectl argo rollouts promote mochi
</code></pre><p>With the deployment complete, the updated application was accessible on the active environment in the blue domain - <code>mochiapp.bluegreen.domain</code>.</p><p><img x-data="{
    altText: `dbebe30b5e9fa94fd865c1c66b41c5f6_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/how-blue-green-deployment-helped-mochi/dbebe30b5e9fa94fd865c1c66b41c5f6_MD5.webp alt=dbebe30b5e9fa94fd865c1c66b41c5f6_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p><p>An alternative would be to utilize the ArgoCD UI for the promotion, as it could prove to be exceptionally helpful for those who may not be able to operate the CLI, including QC, during the release rollout. Additionally, any issues that may arise can quickly be reverted with just the click of the &ldquo;Rollback&rdquo; button.</p><p><img x-data="{
    altText: `8a98dc8c92776e0f68f1db43bf3b4a9a_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/how-blue-green-deployment-helped-mochi/8a98dc8c92776e0f68f1db43bf3b4a9a_MD5.webp alt=8a98dc8c92776e0f68f1db43bf3b4a9a_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p><p><img x-data="{
    altText: `8ee42dc2d4a9b07dbfc76db9b009a8cc_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/how-blue-green-deployment-helped-mochi/8ee42dc2d4a9b07dbfc76db9b009a8cc_MD5.webp alt=8ee42dc2d4a9b07dbfc76db9b009a8cc_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p><h2 id=conclusion><a href=#conclusion>Conclusion <a href=#conclusion></a></a></h2><p>This case study helped us demonstrate the value of blue-green deployment in reducing downtime, improving user experience, and streamlining the update process for applications like Mochi Bot.</p><p>Implementing a blue-green deployment strategy for Mochi Bot proved to be a smooth and hassle-free process. It provided an immediate benefit by eliminating inconsistencies between pod updates during deployment. Thankfully, as a result, the user experience remained seamless and uninterrupted during application updates.</p><p>Moving forward, our team plans to integrate <a href=https://radar.d.foundation/k6-ce823e5b593c4850afc1153c1beefbed>K6</a> for API testing to improve the performance and reliability of Mochi Bot. We aim to establish a quality gate for the green version to ensure that only thoroughly tested and stable releases are deployed to the live environment.</p><h3 id=come-be-with-us><a href=#come-be-with-us>Come be with us <a href=#come-be-with-us></a></a></h3><p>We’d love to have you in our next chapter, by all means.</p><ul><li>Discover what we do: <a href=http://dwarves.foundation/>dwarves.foundation</a></li><li>Meet our team: <a href=http://discord.gg/dwarvesv>discord.gg/dwarvesv</a></li><li>Join the squad: <a href=http://careers.d.foundation/>careers.d.foundation</a></li></ul><p>Follow our journey</p><ul><li>Fanpage: <a href=http://facebook.com/dwarvesf>facebook.com/dwarvesf</a></li><li>LinkedIn: <a href=http://linkedin.com/company/dwarvesf>linkedin.com/company/dwarvesf</a></li><li>Substack: <a href=https://note.d.foundation/>https://note.d.foundation/</a></li></ul></main></div><footer><span><b>Dwarves, LLC</b> © 2015 - 2023 All rights reserved.</span></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-core.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js></script></body></html>