<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=keywords content><meta name=title content="Dcos Series Part 3 Service Discovery And Load Balancing"><meta name=description content><meta property="og:title" content="Dcos Series Part 3 Service Discovery And Load Balancing"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://note.d.foundation/memo/dcos-series-part-3---service-discovery-and-load-balancing/"><meta property="og:image" content="https://note.d.foundation/img/LOGO.png"><meta property="twitter:title" content="Dcos Series Part 3 Service Discovery And Load Balancing"><meta property="twitter:description" content><meta property="twitter:type" content="article"><meta property="twitter:url" content="https://note.d.foundation/memo/dcos-series-part-3---service-discovery-and-load-balancing/"><meta property="twitter:image" content="https://note.d.foundation/img/LOGO.png"><link rel=icon type=image/x-icon href=https://note.d.foundation/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://note.d.foundation/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://note.d.foundation/favicon-32x32.png><link rel=apple-touch-icon href=https://note.d.foundation/apple-touch-icon.png><title>Dcos Series Part 3 Service Discovery And Load Balancing</title>
<link rel=canonical href=https://note.d.foundation/memo/dcos-series-part-3---service-discovery-and-load-balancing/><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vs.min.css integrity="sha512-Jn4HzkCnzA7Bc+lbSQHAMeen0EhSTy71o9yJbXZtQx9VvozKVBV/2zfR3VyuDFIxGvHgbOMMNvb80l+jxFBC1Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: dark)"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: light)"><script defer data-domain=note.d.foundation src=https://plausible.io/js/script.js></script><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script><link rel=preconnect href=https://B0BWKXLVM9-dsn.algolia.net crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script><style>body{font-family:ibm plex sans,sans-serif;font-size:1rem;color:#000;text-rendering:optimizeLegibility;padding:2rem;max-width:100%;margin:0;padding:0;background-color:var(--primary-background-color-light);line-height:1.5;min-height:100vh;display:flex;flex-direction:column;hyphens:auto}h1,h2,h3,h4{color:var(--primary-font-color);line-height:1.24}h1{font-size:32pt}h2{font-size:24pt}h3{font-size:16pt}h4{font-size:12pt}a[href^="#"]{text-decoration:none}time{padding-right:1rem}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #eee}img{max-width:100%}video{max-width:100%}a,a:visited{color:#000}q{font-size:20px;max-width:500px;display:block;margin-left:30px}pre{font-family:monospace!important;background:#000!important;color:#dadada;padding:4px!important;margin:0!important;border-radius:2px;overflow-x:auto;width:100%;max-width:100vw!important;box-sizing:border-box;background-clip:padding-box}pre>code{text-indent:0;white-space:inherit;font-weight:400;padding:15px!important;box-sizing:border-box;background-clip:padding-box}code{line-height:1.5!important;font-family:monospace!important;font-size:12px!important;background:#333!important;color:#dadada;padding:2px 5px;white-space:wrap;border-radius:2px;font-weight:700;display:inline-block;margin-bottom:-4px;box-sizing:border-box;background-clip:padding-box}code comment{color:#777}table code{margin:0;background:var(--secondary-background-color-light)!important;color:var(--secondary-font-color-light);border:.5px solid var(--secondary-font-color-light)}span a,span a:visited{color:inherit}[style*="color:yellow"]{color:gold!important}[style*="color:blue"]{color:#6495ed!important}[style*="color:red"]{color:crimson!important}@media(prefers-color-scheme:dark){a,a:visited{color:#dadada}pre{font-family:monospace!important;background:#fff!important;color:var(--primary-background-color)}code{font-family:monospace!important;background:#ddd!important;color:var(--primary-background-color)}table code{background:var(--secondary-background-color)!important;color:var(--secondary-font-color)}}iframe{box-sizing:border-box;max-width:100%}@media(prefers-color-scheme:light){h1,h2,h3,h4{color:var(--primary-font-color-light)}}@media screen and (max-width:1100px){h1{font-size:calc(1.45rem + 2vw)}h2{font-size:calc(1rem + 1.5vw)}h3{font-size:calc(1rem + 1vw)}h4{font-size:calc(1rem + .5vw)}}:root{--primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--primary-font-color:#ddd;--primary-font-color-light:#333;--secondary-font-color:#e8e8e8;--secondary-font-color-light:#717171;--primary-background-color:#1e1e1e;--primary-background-color-light:#fff;--secondary-background-color:#282828;--secondary-background-color-light:#f6f6f6;--border-color:#3d3d3d;--border-color-light:#e7e7e7;--container-max-width:1240px;--main-padding:36px;--column-gap:24px;--nav-sidebar-width:200px;--nav-sidebar-offset:0px}.grid .title{grid-area:title;margin:32px 0 0!important;color:var(--primary-color)}.grid .subtitle{grid-area:subtitle;font-size:18px;padding-top:16px;padding-bottom:32px}.grid #docsearch{grid-area:docsearch}.grid #docsearch>button{width:90%;height:75%;border-radius:0}.grid #docsearch>button>span{padding-left:12px;font-family:ibm plex sans,sans-serif}.DocSearch-Footer{box-shadow:none}.active{color:var(--primary-color);line-height:1;border-bottom:2px solid var(--primary-color);padding-top:4px!important}nav.tab-menu{grid-area:tabmenu;border-bottom:1px solid var(--border-color-light);padding-bottom:0;overflow:auto}nav.tab-menu ul{list-style-type:none;padding:0;margin-bottom:0;display:inline-grid;grid-auto-flow:column;grid-template-rows:1fr;grid-template-columns:repeat(auto-fit,minmax(min-content,1fr));column-gap:48px}nav.tab-menu ul li{font-size:16px;font-weight:500;display:inline-block;padding:0 0 16px;width:min-content}nav.tab-menu ul li a{text-decoration:none;color:inherit}nav.tab-menu ul li a:hover{background-color:var(--primary-background-color);padding:0}nav.tab-menu ul li:last-of-type{margin-right:30px!important}@media(prefers-color-scheme:dark){nav.tab-menu{border-bottom:1px solid var(--border-color)}}@media only screen and (max-width:1100px){.DocSearch{width:100%!important;height:50px!important;padding:0;margin:0}}nav.menu{padding:calc(var(--main-padding) - 12px)var(--main-padding);line-height:22px;white-space:nowrap;grid-area:nav}details{margin-left:-7px;overflow:hidden;font-size:14px}summary{display:block;padding:5px 5px 12px 20px;position:relative;cursor:pointer;font-size:20px;font-weight:600;text-transform:capitalize;user-select:none}nav section details:not(:last-of-type) ul{margin-bottom:24px}summary:before{content:'\25B8';position:absolute;top:7px;left:0;transform:rotate(0);transform-origin:50% 50%;transition:.25s transform ease;font-size:16px;height:16px;width:16px;font-weight:200;display:flex;justify-content:center;align-items:center}summary:before>*{height:4px;width:4px}details[open]>summary:before{transform:rotate(90deg)}details summary::-webkit-details-marker{display:none}details>ul{margin-bottom:0}hr{margin:20px 0!important;width:100%;max-width:inherit;border-color:var(--secondary-background-color-light)}nav.menu{background-color:var(--secondary-background-color-light)}nav .site-nav{display:inline-block;width:100%}nav .site-nav section{margin-top:-2px}nav .site-nav section h2{margin:20px 0;font-size:24px;text-transform:lowercase}nav.menu ul{display:inline-grid;grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(auto-fill,minmax(var(--nav-sidebar-width),1fr));padding:0 10px 10px 0;margin:0;list-style-type:none;line-height:22px;box-sizing:border-box}nav .site-nav ul li{list-style-type:none;display:flex;font-variant-numeric:tabular-nums;font-size:14px;padding-left:20px;max-width:fit-content}nav .site-nav ul li a{padding:0 4px}.load-more{font-style:italic;padding-top:8px;color:var(--primary-color)!important;cursor:pointer}@media(prefers-color-scheme:dark){nav.menu{background-color:var(--secondary-background-color)}hr{border-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){nav.menu{padding:4.5%}nav.menu ul{width:100%;row-gap:4px;column-gap:4px}nav .site-nav section{margin:0 10px 10px 0}nav.menu{max-width:100%;box-sizing:border-box;display:inline-block}}footer{padding:var(--main-padding);clear:both;border-top:1px solid var(--border-color-light)}footer span{color:var(--secondary-font-color-light)}@media(prefers-color-scheme:dark){footer{border-top:1px solid var(--border-color)}footer span{color:var(--secondary-font-color)}}.note-title{display:inline-grid;width:100%;row-gap:12px;margin:0;grid-template-areas:"pagetitle pagetitle" "date tags" "authors tags";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(2,1fr)}.note-title .pagetitle{grid-area:pagetitle;margin:0}.note-title .date{grid-area:date;color:#636466}.note-title .tags{display:inline-flex;flex-wrap:wrap;gap:6px;grid-area:tags;justify-self:right;justify-content:right}.note-title .tags .tag{padding:1px 6px;border-radius:4px;background-color:var(--secondary-background-color-light);height:fit-content;text-decoration:none;color:var(--secondary-font-color-light)}.note-title .authors{grid-area:authors}.clear-title{grid-template-areas:"pagetitle pagetitle";gap:0}.clear-title .date{display:none}.clear-title .tags{display:none}.clear-title .authors{display:none}code.button{background:var(--primary-background-color-light);color:#000;font-size:smaller;display:inline-block;padding:0 6px;font-weight:700;border-radius:2px;line-height:22px}.grid{display:inline-grid;grid-template-areas:"title title title title" "subtitle subtitle docsearch docsearch" "tabmenu tabmenu tabmenu tabmenu" "nav content content pagenav" "nav content content pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:325px 2fr 2fr 1fr;column-gap:var(--column-gap)}.grid>*{padding-right:calc(var(--main-padding) - 12px);padding-left:calc(var(--main-padding) + 12px)}#docsearch{grid-area:docsearch}main{grid-area:content;display:inline-block;padding:var(--main-padding);width:calc(100vw - 325px - 72px);max-width:var(--container-max-width);box-sizing:border-box;overflow-wrap:break-word;hyphens:none;justify-self:left}main ul{line-height:25px;margin:0;padding:0;padding-inline-start:40px}main ul>li>a{text-decoration:underline}.scrollable{overflow:auto}.dual-list>ul{columns:2}.single-list>ul{columns:2}.profile img{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}.profile object{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}table,th,td{border:1px solid;border-collapse:collapse;border-spacing:0;border-color:var(--border-color-light)}thead *{padding:6px 12px;background-color:var(--secondary-background-color-light)}th,td{padding:6px 12px;overflow:hidden;text-overflow:ellipsis;vertical-align:top;text-align:left}td:has(img){padding:12px;line-height:0}table{table-layout:fixed}table:has(th:empty){border:none}table:has(th:empty) th{border:none;padding:0;line-height:0}table:has(th:empty) td{border:none}table:has(img){width:100%;height:100%}table:has(img) td{min-width:200px}table:has(img) img{width:100%!important;height:100%!important;object-fit:cover}#TableOfContents>ul>li>a{text-decoration:underline}#TableOfContents>ul{display:grid;column-gap:var(--column-gap);box-sizing:border-box;grid-template-columns:repeat(auto-fill,minmax(0,calc(50% - var(--column-gap))));line-height:20px}#TableOfContents li{white-space:nowrap;list-style-type:decimal-leading-zero;list-style-position:inside;overflow:hidden;text-overflow:ellipsis}.notice{padding:20px;border:2px solid #000;margin-bottom:16px}main>blockquote{padding:20px;border:2px solid #000}main>*{max-width:inherit}li:has(input[type=checkbox]){display:block;list-style-type:none}ul:has(li input[type=checkbox]){padding:0}ul li a{overflow:hidden;text-overflow:ellipsis;white-space:wrap;text-decoration:none;transition:all .25s ease}ul li a:hover{background-color:var(--primary-color);color:#fff;padding-left:4px;padding-right:4px;border-radius:4px;width:100%;z-index:10}ul li p{margin-block-end:0;margin-block-start:0}@media(prefers-color-scheme:dark){html[data-theme=dark]{--docsearch-searchbox-background:var(--secondary-background-color);--docsearch-modal-background:var(--secondary-background-color);--docsearch-footer-background:var(--secondary-background-color);--docsearch-key-gradient:linear-gradient(-26.5deg, #555, var(--secondary-background-color));--docsearch-muted-color:#777;--docsearch-key-shadow:inset 0 -2px 0 0 var(--secondary-background-color),inset 0 0 1px 1px #555,0 2px 2px 0 rgba(3,4,9,0.3)}body{background:var(--primary-background-color);color:#dadada}body select{color:#000;background-color:#fff}.project{border-left:2px solid #fff}.notice{border-color:#fff}.mono{filter:invert(1)}.progress>div{background-color:#fff}.progress>div>span{color:#000}main>blockquote{border-color:#fff}ul li a{background-color:inherit}section>ul li a{background-color:inherit}.note-title .tags .tag{background-color:var(--secondary-background-color);color:var(--secondary-font-color)}table,th,td{border-color:var(--border-color)}thead *{background-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){.grid{display:inline-grid;grid-template-areas:"title" "subtitle" "docsearch" "tabmenu" "content" "nav" "pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.grid>*{padding-right:4.5%;padding-left:4.5%}.note-title{width:100%;grid-template-areas:"pagetitle" "date" "tags" "authors";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.note-title .tags{max-width:max-content;justify-self:left;justify-content:flex-start}main{justify-self:center;width:100%;max-width:700px}}.col-2{display:inline-grid;column-gap:36px;padding-bottom:36px;grid-template-columns:repeat(auto-fit,minmax(20%,1fr))}.col-2>*{overflow-wrap:break-word;overflow:auto}</style><script defer src=/js/process-comments.js></script><script defer src=/js/tab-menu.js></script><script defer src=/js/markdown-entities.js></script><script defer src=/js/algolia.js></script><script defer src=/js/dark-light-check.js></script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"memo","name":"Dcos Series Part 3 Service Discovery And Load Balancing","headline":"Dcos Series Part 3 Service Discovery And Load Balancing","alternativeHeadline":"","description":"The Mesosphere Datacenter Operating System (DCOS) provides useful tooling for service discovery and load balancing. One of the primary tools is Marathon Load Balancer, which will be the focus of this post.\nAfter you boot a DCOS cluster, all tasks can be discovered by using Mesos-DNS. Discovery through DNS, however, has some limitations that include:\nDNS does not identify service ports, unless you use an SRV query; most apps are not able to use SRV records “out of the box.","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/note.d.foundation\/memo\/dcos-series-part-3---service-discovery-and-load-balancing\/"},"author":{"@type":"Person","name":"Han Ngo"},"creator":{"@type":"Person","name":"Han Ngo"},"accountablePerson":{"@type":"Person","name":"Han Ngo"},"copyrightHolder":"Dwarves Foundation","copyrightYear":"2017","date":"2017-05-17T00:00:00.00Z","dateCreated":"2017-05-17T00:00:00.00Z","datePublished":"2017-05-17T00:00:00.00Z","dateModified":"2017-05-17T00:00:00.00Z","publisher":{"@type":"Organization","name":"Dwarves Foundation","url":"https://note.d.foundation/","logo":{"@type":"ImageObject","url":"https:\/\/note.d.foundation\/","width":"32","height":"32"}},"image":"https://note.d.foundation/","url":"https:\/\/note.d.foundation\/memo\/dcos-series-part-3---service-discovery-and-load-balancing\/","wordCount":"959","genre":["dcos"],"keywords":["dcos"]}</script><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script type=text/javascript>window.addEventListener("DOMContentLoaded",function(){document.body.style.visibility="visible",document.body.style.opacity=1})</script></head><body><div class=grid><h1 class=title><a style=color:inherit;text-decoration:none href=/site-index>Dwarves Notes</a></h1><div class=subtitle>A collection of notes for everything we do and operate at Dwarves.</div><div id=docsearch></div><nav class=tab-menu x-data="{
    currentUrl: `/memo/dcos-series-part-3---service-discovery-and-load-balancing/`,
    links: [
      { title: 'Home', url: '/home/' },
      { title: 'Consulting', url: '/memo/consulting/' },
      { title: 'Labs', url: '/memo/labs' },
      { title: 'Earn', url: '/earn/' },
      { title: 'Hiring', url: '/hiring/' },
      { title: 'Newsletter', url: '/newsletter/' },
      { title: 'Events', url: '/events/' },
    ],
    activeUrl: '',
    isActiveUrl(url) {
      if (!this.activeUrl) {
        this.activeUrl = this.currentUrl.startsWith(url);
        return this.activeUrl;
      }
    },
  }"><ul><template x-for="item in links"><li x-bind:class="{ 'active': isActiveUrl(item.url) }"><a x-bind:href=item.url x-text=item.title></a></li></template></ul></nav><nav class=menu><section class=site-nav x-data="{
      currentUrl: `/memo/dcos-series-part-3---service-discovery-and-load-balancing/`,
      get data() {
        const dataString = `[]`;
        const data = JSON.parse(dataString);
        data.sort((a, b) => Date.parse(b.date) - Date.parse(a.date));
        console.log(data);
        return data;
      },
    }"><template x-for="item in data" x-bind:key=item><details x-data="{ start: 0, end: 10, loaded: false, loadText: 'Load more...', }" open><summary>Pinned Notes</summary><ul><li><a x-bind:href=item.url x-text=item.title></a></li></ul></details></template></section></nav><main x-data='{
      currentUrl: `/memo/dcos-series-part-3---service-discovery-and-load-balancing/`,
      title: `Dcos Series Part 3 Service Discovery And Load Balancing`,
      get tagsData() {
        const dataString = `[{"tags":["dcos"],"url":"/memo/dcos-series-part-3---service-discovery-and-load-balancing/"}]`;
        const data = JSON.parse(dataString);
        return data;
      },
      isClearPage() {
        const showFrontmatter = (/true/i).test(`true`);
        return !showFrontmatter || this.currentUrl.includes(&#39;home&#39;) || this.currentUrl.includes(&#39;tags&#39;);
      },
      isTagPage() {
        return this.currentUrl.includes(&#39;tags&#39;);
      }
    }'><template x-if=!!title><div x-bind:class="{ 'note-title': true, 'clear-title': isClearPage() }"><div class=title-index style=display:none>Dcos Series Part 3 Service Discovery And Load Balancing</div><div class=tags-index style=display:none>tags: dcos</div><template x-if=isTagPage()><h1 class=pagetitle x-text="`#${title}`"></h1></template><template x-if=!isTagPage()><h1 class=pagetitle x-text=title>Dcos Series Part 3 Service Discovery And Load Balancing</h1></template><div class=date>May 17, 2017</div><template x-for="data in tagsData"><template x-if="data.tags && data.tags.length > 0"><div class=tags>Tags:
<template x-for="tag in data.tags"><a class=tag x-bind:href="`/tags/${tag.toLowerCase()}`" x-text=tag></a></template></div></template></template></div><hr></template><p>The Mesosphere Datacenter Operating System (DCOS) provides useful tooling for service discovery and load balancing. One of the primary tools is Marathon Load Balancer, which will be the focus of this post.</p><p>After you boot a DCOS cluster, all tasks can be discovered by using Mesos-DNS. Discovery through DNS, however, has some limitations that include:</p><ul><li>DNS does not identify service ports, unless you use an SRV query; most apps are not able to use SRV records “out of the box.”</li><li>DNS does not have fast failover.</li><li>DNS records have a TTL (time to live) and Mesos-DNS uses polling to create the DNS records; this can result in stale records.</li><li>DNS records do not provide any service health data.</li><li>Some applications and libraries do not correctly handle multiple A records; in some cases the query might be cached and not correctly reloaded as required.</li><li>To address these concerns, we provide a tool for Marathon called Marathon Load Balancer, or marathon-lb for short.</li></ul><p>Marathon-lb is based on HAProxy, a rapid proxy and load balancer. HAProxy provides proxying and load balancing for TCP and HTTP based applications, with features such as SSL support, HTTP compression, health checking, Lua scripting and more. Marathon-lb subscribes to Marathon’s event bus and updates the HAProxy configuration in real time.</p><p>The marathon-lb tool is available as a package from DC/OS’s universe. To install marathon-lb</p><pre><code class=language-javascript>$ dcos package install marathon-lb
</code></pre><p>To check that marathon-lb is working, find the IP for your public slave and navigate to <code>http://&lt;public-slave-ip>:9090/haproxy?stats.</code> You’ll see a statistics report page.</p><p>Next, we’ll set up our internal LB. To do this, we must first specify some configuration options for the marathon-lb package. Create a file called <code>options.json</code> with the following contents</p><pre><code class=language-javascript>{
  &quot;marathon-lb&quot;:{
    &quot;name&quot;:&quot;marathon-lb-internal&quot;,
    &quot;haproxy-group&quot;:&quot;internal&quot;,
    &quot;bind-http-https&quot;:false,
    &quot;role&quot;:&quot;&quot;
  }
}
</code></pre><p>In this options file, we’re changing a) the name of the app instance, b) the name of the HAProxy group, and b) we’re disabling the HTTP and HTTPS forwarding on ports 80 and 443 (because it’s unneeded).</p><p>Next, run the install command with our new options</p><pre><code class=language-plain_text>$ dcos package install --options=options.json marathon-lb
</code></pre><p>Now we’ll have 2 load balancers: an external LB, and an internal LB. Let’s launch a sample application to demonstrate the features. Here’s our external instance of nginx:</p><pre><code class=language-plain_text>{
  &quot;id&quot;: &quot;nginx-external&quot;,
  &quot;container&quot;: {
    &quot;type&quot;: &quot;DOCKER&quot;,
    &quot;docker&quot;: {
      &quot;image&quot;: &quot;nginx:1.7.7&quot;,
      &quot;network&quot;: &quot;BRIDGE&quot;,
      &quot;portMappings&quot;: [
        { &quot;hostPort&quot;: 0, &quot;containerPort&quot;: 80, &quot;servicePort&quot;: 10000 }
      ],
      &quot;forcePullImage&quot;:true
    }
  },
  &quot;instances&quot;: 1,
  &quot;cpus&quot;: 0.1,
  &quot;mem&quot;: 65,
  &quot;healthChecks&quot;: [{
      &quot;protocol&quot;: &quot;HTTP&quot;,
      &quot;path&quot;: &quot;/&quot;,
      &quot;portIndex&quot;: 0,
      &quot;timeoutSeconds&quot;: 10,
      &quot;gracePeriodSeconds&quot;: 10,
      &quot;intervalSeconds&quot;: 2,
      &quot;maxConsecutiveFailures&quot;: 10
  }],
  &quot;labels&quot;:{
    &quot;HAPROXY_GROUP&quot;:&quot;external&quot;
  }
}
</code></pre><p>You can launch this app on DCOS by pasting the JSON above into a file (called nginx-external.json), and running:</p><pre><code class=language-plain_text>$ dcos marathon app add nginx-external.json
</code></pre><p>The application definition includes a special label with the key HAPROXY_GROUP. This label tells marathon-lb whether or not to expose the application. The external marathon-lb was started with the –group parameter set to external, which is the default. You can inspect the code here, if you’d like.</p><p>And here’s our internal nginx:</p><pre><code class=language-plain_text>{
  &quot;id&quot;: &quot;nginx-internal&quot;,
  &quot;container&quot;: {
    &quot;type&quot;: &quot;DOCKER&quot;,
    &quot;docker&quot;: {
      &quot;image&quot;: &quot;nginx:1.7.7&quot;,
      &quot;network&quot;: &quot;BRIDGE&quot;,
      &quot;portMappings&quot;: [
        { &quot;hostPort&quot;: 0, &quot;containerPort&quot;: 80, &quot;servicePort&quot;: 10001 }
      ],
      &quot;forcePullImage&quot;:true
    }
  },
  &quot;instances&quot;: 1,
  &quot;cpus&quot;: 0.1,
  &quot;mem&quot;: 65,
  &quot;healthChecks&quot;: [{
      &quot;protocol&quot;: &quot;HTTP&quot;,
      &quot;path&quot;: &quot;/&quot;,
      &quot;portIndex&quot;: 0,
      &quot;timeoutSeconds&quot;: 10,
      &quot;gracePeriodSeconds&quot;: 10,
      &quot;intervalSeconds&quot;: 2,
      &quot;maxConsecutiveFailures&quot;: 10
  }],
  &quot;labels&quot;:{
    &quot;HAPROXY_GROUP&quot;:&quot;internal&quot;
  }
}
</code></pre><p>Notice that we’re specifying a servicePort parameter. The servicePort is the port that exposes this service on marathon-lb. By default, port 10000 through to 10100 are reserved for marathon-lb services, so you should begin numbering your service ports from 10000 (that’s 101 service ports, if you’re counting). You may want to use a spreadsheet to keep track of which ports have been allocated to which services for each set of LBs.</p><p>Let’s add one more instance of nginx:</p><pre><code class=language-plain_text>{
  &quot;id&quot;: &quot;nginx-everywhere&quot;,
  &quot;container&quot;: {
    &quot;type&quot;: &quot;DOCKER&quot;,
    &quot;docker&quot;: {
      &quot;image&quot;: &quot;nginx:1.7.7&quot;,
      &quot;network&quot;: &quot;BRIDGE&quot;,
      &quot;portMappings&quot;: [
        { &quot;hostPort&quot;: 0, &quot;containerPort&quot;: 80, &quot;servicePort&quot;: 10002 }
      ],
      &quot;forcePullImage&quot;:true
    }
  },
  &quot;instances&quot;: 1,
  &quot;cpus&quot;: 0.1,
  &quot;mem&quot;: 65,
  &quot;healthChecks&quot;: [{
      &quot;protocol&quot;: &quot;HTTP&quot;,
      &quot;path&quot;: &quot;/&quot;,
      &quot;portIndex&quot;: 0,
      &quot;timeoutSeconds&quot;: 10,
      &quot;gracePeriodSeconds&quot;: 10,
      &quot;intervalSeconds&quot;: 2,
      &quot;maxConsecutiveFailures&quot;: 10
  }],
  &quot;labels&quot;:{
    &quot;HAPROXY_GROUP&quot;:&quot;external,internal&quot;
  }
}
</code></pre><p>This instance of nginx is going to be exposed everywhere. Note that we’ve changed the servicePort so it does not overlap with the other nginx instances.</p><p>Service ports can be defined either by using port mappings (as in the examples above), or with the ports parameter in the Marathon app definition.</p><p>To test our configuration, SSH into one of the instances in the cluster (such as a master), and try curl-ing the endpoints:</p><pre><code class=language-plain_text>$ curl http://marathon-lb.marathon.mesos:10000/

$ curl http://marathon-lb-internal.marathon.mesos:10001/

$ curl http://marathon-lb.marathon.mesos:10002/

$ curl http://marathon-lb-internal.marathon.mesos:10002/
</code></pre><p>Each of these should return the nginx ‘Welcome’ page.</p><h2 id=virtual-host><a href=#virtual-host>Virtual host <a href=#virtual-host></a></a></h2><p>An important feature of marathon-lb is support for virtual hosts. This allows you to route HTTP traffic for multiple hosts (FQDNs) and route requests to the correct endpoint. For example, you could have two distinct web properties, nginx.dwarvesf.com, with DNS for both pointing to the same LB on the same port, and HAProxy will route traffic to the correct endpoint based on the domain name.</p><p>To do so, we need to do 2 things:</p><ol><li>Point your domain to public node which in running <code>marathon-lb</code></li><li>Add this config to marathon JSON configuration file:</li></ol><pre><code class=language-plain_text>  &quot;HAPROXY_0_VHOST&quot;:&quot;nginx.dwarvesf.com&quot;
}
</code></pre><p>So, your configuration file will be like this:</p><pre><code class=language-plain_text>{
  &quot;id&quot;: &quot;nginx-external&quot;,
  &quot;container&quot;: {
    &quot;type&quot;: &quot;DOCKER&quot;,
    &quot;docker&quot;: {
      &quot;image&quot;: &quot;nginx:1.7.7&quot;,
      &quot;network&quot;: &quot;BRIDGE&quot;,
      &quot;portMappings&quot;: [
        { &quot;hostPort&quot;: 0, &quot;containerPort&quot;: 80, &quot;servicePort&quot;: 10000 }
      ],
      &quot;forcePullImage&quot;:true
    }
  },
  &quot;instances&quot;: 1,
  &quot;cpus&quot;: 0.1,
  &quot;mem&quot;: 65,
  &quot;healthChecks&quot;: [{
      &quot;protocol&quot;: &quot;HTTP&quot;,
      &quot;path&quot;: &quot;/&quot;,
      &quot;portIndex&quot;: 0,
      &quot;timeoutSeconds&quot;: 10,
      &quot;gracePeriodSeconds&quot;: 10,
      &quot;intervalSeconds&quot;: 2,
      &quot;maxConsecutiveFailures&quot;: 10
  }],
  &quot;labels&quot;:{
    &quot;HAPROXY_GROUP&quot;: &quot;external&quot;,
    &quot;HAPROXY_0_VHOST&quot;: &quot;nginx.dwarvesf.com&quot;
  }
}
</code></pre><ol><li>Deploy it and let’s check <code>nginx.dwarvesf.com</code></li></ol><p><img x-data="{
    altText: `93c6fdb9cee529cbeb2a4141d910bb8f_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/dcos-series-part-3---service-discovery-and-load-balancing/93c6fdb9cee529cbeb2a4141d910bb8f_MD5.webp alt=93c6fdb9cee529cbeb2a4141d910bb8f_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p><p>or, you also can access by this way <code>&lt;public-node-elb></code>:<code>&lt;service-port></code></p><p><img x-data="{
    altText: `d90d63eed205052f3f560b4a6ebd5fba_MD5.webp`,
    get altWidthHeight() {
      const widthHeightRegex = /^(\d+)(?!x)(\d*)$/g;
      return this.altText.match(widthHeightRegex) ?? [];
    },
  }" src=/memo/assets/dcos-series-part-3---service-discovery-and-load-balancing/d90d63eed205052f3f560b4a6ebd5fba_MD5.webp alt=d90d63eed205052f3f560b4a6ebd5fba_MD5.webp x-bind:style="{ width: altWidthHeight[0] + 'px', height: altWidthHeight[1] + 'px' }" onerror="this.onerror=null"></p></main></div><footer><span><b>Dwarves, LLC</b> © 2015 - 2023 All rights reserved.</span></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-core.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js></script></body></html>