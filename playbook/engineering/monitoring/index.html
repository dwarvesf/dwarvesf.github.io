<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=description property="og:description" content><meta name=keywords content><meta property="og:type" content="website"><meta property="og:url" content="https://note.d.foundation/playbook/engineering/monitoring/"><meta property="og:image" content="https://note.d.foundation/img/LOGO.png"><link rel=icon type=image/x-icon href=https://note.d.foundation/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://note.d.foundation/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://note.d.foundation/favicon-32x32.png><link rel=apple-touch-icon href=https://note.d.foundation/apple-touch-icon.png><title>| Dwarves Foundation</title><meta name=description content><link rel=canonical href=https://note.d.foundation/playbook/engineering/monitoring/><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><script defer data-domain=note.d.foundation src=https://plausible.io/js/script.js></script><style>:root{--primary-color:#dadada;--primary-color-light:#2ea370;--main-padding:48px;--column-gap:20px}body{font:16px sans-serif;color:#000;text-rendering:optimizeLegibility;padding:2rem;max-width:100%;margin:0;padding:0;background-color:#fff;line-height:25px;min-height:100vh;display:flex;flex-direction:column;overflow-wrap:break-word;hyphens:auto}h1,h2,h3,h4{color:var(--primary-color)}h1{font-size:45px;display:none}h2{font-size:30px}h3{font-size:22px}h4{font-size:15px}q{font-size:20px;max-width:500px;display:block;margin-left:30px}pre{font-family:monospace;background:#000;color:#dadada;padding:15px;border-radius:2px;overflow-x:scroll;width:100%;box-sizing:border-box}pre>code{display:block;text-indent:0;white-space:inherit;font-weight:400}code{font-family:monospace;font-size:12px;background:#000;color:#dadada;padding:2px 5px;white-space:wrap;border-radius:2px;font-weight:700;display:inline-block;line-height:16px;overflow-x:scroll;margin-bottom:-4px}code comment{color:#777}code.button{background:#fff;color:#000;font-size:smaller;display:inline-block;padding:0 6px;font-weight:700;border-radius:2px;line-height:22px}a[href*="#"]{text-decoration:none}.grid{display:inline-grid;grid-template-areas:"nav content" "nav content";grid-template-rows:1fr 100vh;grid-template-columns:325px 1fr}nav.menu{padding:29px 0 0 45px;max-width:var(--nav-sidebar-width);line-height:22px;margin-top:-2px;white-space:nowrap;border-right:1px solid #363636;grid-area:nav}details{margin-left:-7px;overflow:hidden;font-size:14px;font-weight:500}summary{padding:5px;display:block;padding-left:24px;position:relative;cursor:pointer}summary:before{content:'';border-width:.4rem;border-style:solid;border-color:transparent transparent transparent #fff;position:absolute;top:10px;left:10px;transform:rotate(0);transform-origin:.2rem 50%;transition:.25s transform ease}details[open]>summary:before{transform:rotate(90deg)}details summary::-webkit-details-marker{display:none}details>ul{margin-bottom:0}hr{margin-left:0}nav .site-nav{margin:20px 0;display:block}nav .site-nav section{margin-top:-2px}nav .site-nav section h2{margin:20px 0;font-size:24px;text-transform:lowercase}nav.menu ul{padding:0 10px 10px 0;margin:0;list-style-type:none;line-height:22px}main{grid-area:content;padding:var(--main-padding);max-width:100%;box-sizing:border-box}main>ul{line-height:25px;margin:0}main>ul>li>a{text-decoration:underline}.dual-list>ul{columns:2}.single-list>ul{columns:2}.profile img{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}.profile object{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}table,th,td{border:1px solid;border-collapse:collapse;border-spacing:0}tr{max-height:100px;max-width:100px}td{padding:0 20px;max-width:300px;max-height:100px;overflow:hidden;text-overflow:ellipsis}td:has(img){padding:0;line-height:0}#TableOfContents>ul>li>a{text-decoration:underline}#TableOfContents>ul{display:grid;column-gap:var(--column-gap);box-sizing:border-box;grid-template-columns:repeat(auto-fill,minmax(var(--nav-sidebar-width),calc(50% - var(--column-gap))));line-height:20px}#TableOfContents li{white-space:nowrap;list-style-type:decimal-leading-zero;list-style-position:inside;overflow:hidden;text-overflow:ellipsis}.notice{padding:20px;border:2px solid #000}main>blockquote{padding:20px;border:2px solid #000}main>*{max-width:600px;margin-bottom:30px}header{padding:var(--main-padding);border-bottom:1px solid #363636}header h1{display:inline}footer{margin-top:auto;padding:var(--main-padding);clear:both}nav .site-nav ul li{list-style-type:none;display:flex;font-variant-numeric:tabular-nums;font-size:14px;padding-left:20px}li:has(input[type=checkbox]){display:block;list-style-type:none}ul:has(li input[type=checkbox]){padding:0}ul li a{overflow:hidden;text-overflow:ellipsis;width:calc(var(--nav-sidebar-width) + var(--nav-sidebar-offset));background-color:#fff}ul li a:hover{white-space:nowrap;width:100%;z-index:10}ul li p{margin-block-end:0;margin-block-start:0}time{padding-right:1rem}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #eee}img{max-width:100%}a,a:visited{color:#000}@media(prefers-color-scheme:dark){a,a:visited{color:#dadada}body{background:#1e1e1e;color:#dadada}body a{color:#dadada}pre{background:#fff;color:#1e1e1e}code{background:#fff;color:#1e1e1e}body select{color:#000;background-color:#fff}.project{border-left:2px solid #fff}.notice{border-color:#fff}.mono{filter:invert(1)}.progress>div{background-color:#fff}.progress>div>span{color:#000}main>blockquote{border-color:#fff}ul li a{background-color:inherit}section>ul li a{background-color:inherit}}@media(prefers-color-scheme:light){h1,h2,h3,h4{color:var(--primary-color-light)}}@media only screen and (max-width:1100px){:root{--nav-sidebar-width:140px;--nav-sidebar-offset:0px}nav{width:100%}nav .site-nav section{margin:0 10px 10px 0}nav.menu{max-width:100%;box-sizing:border-box;display:inline-block}nav .site-nav{display:grid;column-gap:var(--column-gap);grid-template-columns:repeat(auto-fill,minmax(var(--nav-sidebar-width),1fr))}main{display:inline-block;width:unset}main>*{max-width:100%}ul li a{width:var(--nav-sidebar-width)}}</style><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"playbook","name":"","headline":"","alternativeHeadline":"","description":"Monitoring Monitoring Application monitoring Status page Status page format Plain format JSON format HTTP status codes Load balancer health checks Access control Application monitoring Monitoring the full status of a service requires that both OS-level and application-specific monitoring checks are performed. OS-level checks include, for example, CPU, disk or memory usage, running processes, open ports, etc. Application specific checks are, however, the most important from the point of view of the running service.","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/note.d.foundation\/playbook\/engineering\/monitoring\/"},"author":{"@type":"Person","name":"Han Ngo"},"creator":{"@type":"Person","name":"Han Ngo"},"accountablePerson":{"@type":"Person","name":"Han Ngo"},"copyrightHolder":"Dwarves Foundation","copyrightYear":"0001","date":"0001-01-01T00:00:00.00Z","dateCreated":"0001-01-01T00:00:00.00Z","datePublished":"0001-01-01T00:00:00.00Z","dateModified":"0001-01-01T00:00:00.00Z","publisher":{"@type":"Organization","name":"Dwarves Foundation","url":"https://note.d.foundation/","logo":{"@type":"ImageObject","url":"https:\/\/note.d.foundation\/","width":"32","height":"32"}},"image":"https://note.d.foundation/","url":"https:\/\/note.d.foundation\/playbook\/engineering\/monitoring\/","wordCount":"1358","genre":[],"keywords":[]}</script><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script type=text/javascript>window.addEventListener("DOMContentLoaded",function(){document.body.style.visibility="visible",document.body.style.opacity=1})</script></head><body class=playbook><div class=grid><nav class=menu><h3>Dwarves Notes</h3><section class=site-nav><details><summary>home</summary><ul><li><a href=/site-index/>Index</a></li></ul></details><details><summary>earn</summary><ul><li><a href=/earn/trend-command/>?trend command</a></li><li><a href=/earn/fleeting-notes/>A discord cmd to receive a link, and create a brainery fleeting note</a></li><li><a href=/earn/summary-article/>A discord cmd to summary article, using ChatGPT</a></li><li><a href=/earn/dwarvesf-map/>A webpage showing where the Dwarves from</a></li><li><a href=/earn/discord-publish-braniery/>Add new discord command to publish new brainery post</a></li><li><a href=/earn/brainery-metrics-report/>Brainery metrics report</a></li><li><a href=/earn/centralize-dwarves-calendar/>Centralize Dwarves Calendar</a></li><li><a href=/earn/chatbot-adversarial-prompt/>Chatbot: Adversarial prompts - politics, weapons, etc</a></li><li><a href=/earn/chatbot-prompt-size/>Chatbot: prompt size, context (zero shot)</a></li><li><a href=/earn/company-signature/>Company Signature</a></li><li><a href=/earn/company-social-graph/>Company Social Graph</a></li><li><a href=/earn/consulting-map/>Consulting record webpage</a></li><li><a href=/earn/layer-2-zk-rollup/>Design system for layer 2 using ZK rollup</a></li><li><a href=/earn/economic-calendar/>Economic calendar</a></li><li><a href=/earn/engagament-log/>Engagement Log</a></li><li><a href=/earn/feature-toggle/>Feature toggle</a></li><li><a href=/earn/financial-literacy-outline/>Financial Literacy outline: Phổ cập Kiến thức Tài chính</a></li><li><a href=/earn/fortress-shanky-data/>Fortress: API to show shanky data</a></li><li><a href=/earn/fortress-mma-score/>Fortress: MMA data</a></li><li><a href=/earn/hunger-game/>Hunger Game - Submit 2022</a></li><li><a href=/earn/integrate-rss-feed/>Integrate RSS feeds to chapter discord channels</a></li><li><a href=/earn/integrate-ts-reset/>Integrate ts-reset to nextjs boilerplate</a></li><li><a href=/earn/locale-web-mobile/>Locale on Web, Mobile</a></li><li><a href=/earn/monorepo-deployment-flow/>Monorepo deployment flow with Vercel</a></li><li><a href=/earn/enigma-checksum/>Open source Enigma checksum</a></li><li><a href=/earn/optimize-query-database/>Optimize Query Database 500M records, filter multiple tables</a></li><li><a href=/earn/project-changelog-tool/>Project Weekly Changelog Tooling</a></li><li><a href=/earn/react-server-component/>React Server Componen</a></li><li><a href=/earn/discord-role/>Rework Discord Role</a></li><li><a href=/earn/dwarves-email-domain/>Rework Dwarves Email Domain</a></li><li><a href=/earn/tech-radar-report/>Tech radar status report</a></li><li><a href=/earn/treasure-hunt/>Treasure Hunt - Submit 2022</a></li><li><a href=/earn/upgraed-nextjs-boilerplate/>Upgrade nextjs-boilerplate to Nextjs 13</a></li><li><a href=/earn/zod-nextjs-boilerplate/>Use Zod to validate schema in nextjs-boilerplate</a></li><li><a href=/earn/type-safe-framework/>wagmi website, fork xkcd, with crm for img uploading</a></li></ul></details><details><summary>hiring</summary><ul><li><a href=/hiring/additional-info/benefits-and-perks/>benefits-and-perks</a></li><li><a href=/hiring/additional-info/how-we-hire/>how-we-hire</a></li><li><a href=/hiring/additional-info/how-we-work/>how-we-work</a></li><li><a href=/hiring/additional-info/making-a-career/>making-a-career</a></li><li><a href=/hiring/additional-info/what-we-stand-for/>what-we-stand-for</a></li><li><a href=/hiring/additional-info/what-we-value/>what-we-value</a></li><li><a href=/hiring/additional-info/where-we-work/>where-we-work</a></li></ul></details><details><summary>memo</summary><ul><li><a href=/memo/august-forward-engineering/>august-forward-engineering</a></li></ul></details></section></nav><main><h1 id=monitoring><a href=#monitoring>Monitoring <a href=#monitoring></a></a></h1><ul><li><a href=#monitoring>Monitoring</a></li><li><a href=#application-monitoring>Application monitoring</a><ul><li><a href=#status-page>Status page</a></li><li><a href=#status-page-format>Status page format</a><ul><li><a href=#plain-format>Plain format</a></li><li><a href=#json-format>JSON format</a></li></ul></li><li><a href=#http-status-codes>HTTP status codes</a></li><li><a href=#load-balancer-health-checks>Load balancer health checks</a></li><li><a href=#access-control>Access control</a></li></ul></li></ul><h1 id=application-monitoring><a href=#application-monitoring>Application monitoring <a href=#application-monitoring></a></a></h1><p>Monitoring the full status of a service requires that both OS-level and application-specific monitoring checks are performed. OS-level checks include, for example, CPU, disk or memory usage, running processes, open ports, etc. Application specific checks are, however, the most important from the point of view of the running service. These can be anything from &ldquo;does this URL respond and return the HTTP status 200&rdquo;, to checking database connectivity, data consistency, and so on.</p><p>This section describes a way to implement the application-specific checks, which would make it easier to monitor the overall application health and give full control to the application developers to determine what checks are meaningful in the context of the concrete application.</p><p>In essence, the idea is to have a single endpoint (an application URL) that can give a good status overview of the entire application. This is implemented inside the application and requires work from the project team, but on the other hand, the project team is the one who can really define what is an OK state of the application and what is considered an ERROR state.</p><p>The application could implement any number of &ldquo;subsystem&rdquo; checks. For example,</p><ul><li>connection to the database is up</li><li>data is in an consistent state (e.g. a list of items in a certain database table is meaningful)</li><li>3rd party services that the application integrates to are reachable</li><li>ElasticSearch indexes are in a consistent state</li><li>anything else that makes sense for the application</li></ul><p>A combined overview status should be provided by the application, aggregating the information from the various subsystem checks. The idea is that an external monitoring system can track only this combined overview, so that the external monitoring does not need to be reconfigured when a new application check is added or modified. Moreover, the developers are the ones that can decide about what the overall status is based on regarding subsystem checks (i.e. which ones are critical, while ones are not, etc).</p><h2 id=status-page><a href=#status-page>Status page <a href=#status-page></a></a></h2><p>All status checks SHOULD be accessible under <code>/healthz</code> URLs as follows:</p><ul><li><code>/healthz</code> - the overall status page (mandatory)</li><li><code>/healthz/subsystem1</code> - a status check for speciffic subsystem (optional)</li><li>&mldr;</li></ul><p>The main <code>/healthz</code> page should at a minimum give an overall status of the system, as described in the next section. This means that the main <code>/healthz</code> page should execute ALL subsystem checks and report the aggregated overall system status. It is up to the developers to decide how the overall system status is determined based on the subsystems. For example an <code>ERROR</code> state of some non-critical subsystem may only generate an overall <code>WARNING</code> status.</p><p>For performance reasons, some subsystem checks may be excluded from this overall <code>/healthz</code> page - for example, when the check causes higher resource usage, takes longer time to complete, etc. Overall, the main status page should be light enough so that it can be polled relatively often (every 1-3 minutes) and not cause too much load on the system. Subsystem checks that are excluded from the overall status check should have their own URLs, as shown above. Naturally, monitoring those would require modifications in the monitoring system configuration. To overcome this, a different approach can be taken: the application could perform the heavy subsystem checks in a background process at a rate that is acceptable and store the status internally. This would allow the main status page to reflect also these heavy checks (e.g. it would retrieve the last performed check status). This approach should be used, unless its implementation is too difficult.</p><h2 id=status-page-format><a href=#status-page-format>Status page format <a href=#status-page-format></a></a></h2><p>We propose two alternative formats for the status pages - <code>plain</code> and <code>JSON</code>.</p><h3 id=plain-format><a href=#plain-format>Plain format <a href=#plain-format></a></a></h3><p>The plain format has one status per line in the form <code>key: value</code>. The key is a subsystem/check name and the value is the status value. The status value can be one of:</p><ul><li><code>OK</code></li><li><code>WARN Message</code></li><li><code>ERROR Message</code></li></ul><p>where <code>Message</code> can be some meaningful text, that can help quickly identify the problem. The message is single line, without specified length restriction, but use common sense - e.g. probably should not be longer than 200 characters.</p><p>The main status page MUST have a key called <code>status</code> that shows the overall aggregated application status. The individual subsystem check status lines are optional. Subsystem status keys should have a suffix <code>_status</code>. Here are some examples:</p><p>When everything is ok:</p><pre><code>status: OK
database_status: OK
elastic_search_status: OK
</code></pre><p>When some check is failing:</p><pre><code>status: ERROR Database is not accessible
database_status: ERROR Connection failed
elastic_search_status: OK
</code></pre><p>Multiple failures at the same time:</p><pre><code>status: ERROR failed subsystems: database, elasticsearch. For details see https://myapp.example.com/status
database_status: ERROR Connection failed
elastic_search_status: WARN Too few entries in index A.
</code></pre><p>In addition to the status lines, a status page can have non-status keys. For example, those can be showing some metrics (that may or may not be monitored). The additional keys must be prefixed with the subsystem name.</p><pre><code>status: OK
database_status: OK
database_customers: 378
database_items: 8934748
elastic_search_status: OK
elastic_search_shards: 20
</code></pre><p>The overall status may naturally be based on some of the metrics:</p><pre><code>status: WARN Too few items in database
database_status: WARN Too few customers in database
database_customers: 378
database_items: 1
elastic_search_status: OK
elastic_search_shards: 20
</code></pre><p>Subsystem checks that have their own URL (<code>/healthz/subsystemX</code>) should follow a similar format, having a mandatory key <code>status</code> and a number of optional additional keys. Example for e.g. <code>/healthz/database</code>:</p><pre><code>status: OK
connection_pool: 30
latency: 2
</code></pre><h3 id=json-format><a href=#json-format>JSON format <a href=#json-format></a></a></h3><p>The JSON format of the status pages can be often preferable, for example when the tooling or integration to other systems is easier to achieve via a common data format.</p><p>The status values follow the same format as described above - <code>OK</code>, <code>WARN Message</code> and <code>ERROR Message</code>.</p><p>The equivalent to the status key form the plain format is a <code>status</code> key in the root JSON object. Subsystems should use nested objects also having a mandatory <code>status</code> key. Here are some examples:</p><p>All is fine:</p><pre><code class=language-json>{
    &quot;status&quot;: &quot;OK&quot;,
    &quot;database&quot;: {
        &quot;status&quot;: &quot;OK&quot;
    },
    &quot;elastic_search&quot;: {
        &quot;status&quot;: &quot;OK&quot;
    }
}
</code></pre><p>Status page with additional metrics:</p><pre><code class=language-json>{
    &quot;status&quot;: &quot;OK&quot;,
    &quot;uptime&quot;: 18234,
    &quot;database&quot;: {
        &quot;status&quot;: &quot;OK&quot;,
        &quot;connection_pool&quot;: 30
    },
    &quot;elastic_search&quot;: {
        &quot;status&quot;: &quot;OK&quot;,
        &quot;multinode&quot;: false
    }
}
</code></pre><p>Something failing:</p><pre><code class=language-json>{
    &quot;status&quot;: &quot;ERROR Database is not accessible. See https://myapp.example.com/healthz for details.&quot;,
    &quot;database&quot;: {
        &quot;status&quot;: &quot;ERROR Connection failed&quot;,
        &quot;connection_timeout&quot;: 30
    },
    &quot;elastic_search&quot;: {
        &quot;status&quot;: &quot;OK&quot;
    }
}
</code></pre><h2 id=http-status-codes><a href=#http-status-codes>HTTP status codes <a href=#http-status-codes></a></a></h2><p>Whenever the overall application status is OK, the HTTP status code in the status page response MUST be set to 200 (OK). Otherwise a 5XX error code SHOULD be set. For example, code 500 (Internal Server Error) could be used. Optionally, non-critical WARN status may still respond with 200.</p><h2 id=load-balancer-health-checks><a href=#load-balancer-health-checks>Load balancer health checks <a href=#load-balancer-health-checks></a></a></h2><p>Often the application is running behind a load balaner. Load balancers typically can monitor application servers by polling a given URL. The health check is used so that the load balancer can stop routing traffic to the failing application servers.</p><p>The overall <code>/healthz</code> page is a good candidate for the load balancer health check URL. However, a separate dedicated status page for a load balancer health check provides an important benefit. Such a page can be fine-tuned for when the application is considered to be healthy from the load balancer&rsquo;s perspective. For example, an error in a subsystem may still be considered a critical error for the overall application status, but does not necessarily need to cause the application server to be removed from the load balancer pool. A good example is a 3rd party integration status check. The load balancer health check page should only return non-200 status code when the application instance must be considered non-operational.</p><p>The load balancer health check page should be placed at a <code>/status/healthz</code> URL. Depending on your load balancer, the format of that page may deviate from the overall status format described here. Some load balancers may even observe only the returned HTTP status code.</p><h2 id=access-control><a href=#access-control>Access control <a href=#access-control></a></a></h2><p>The status pages may need proper authorization in place, especially in case they expose debugging information in status messages or application metrics. HTTP basic authentication or IP-based restrictions are usually good enough candidates to consider.</p></main></div></body></html>